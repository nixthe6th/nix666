name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Check CLI scripts exist
      run: |
        test -f scripts/nix
        test -f scripts/nixcommit
        test -f scripts/nixwater
        test -f scripts/nixwhen
        test -f scripts/nixtimer
        test -f scripts/nixweather
        test -f scripts/nixdecide
        echo "✓ All CLI scripts present"
    
    - name: Test Node.js tools load
      run: |
        node -e "require('./today.js')" || true
        node -e "require('./calc.js')" || true
        node -e "require('./convert.js')" || true
        node -e "require('./correlate.js')" || true
        node -e "require('./sync.js')" || true
        node -e "require('./sentiment.js')" || true
        echo "✓ Core tools syntax valid"
    
    - name: Check JSON data files
      run: |
        cat bookmarks.json | node -e "JSON.parse(require('fs').readFileSync(0)); console.log('✓ bookmarks.json valid')"
        cat quotes.json | node -e "JSON.parse(require('fs').readFileSync(0)); console.log('✓ quotes.json valid')"
        cat ideas.json | node -e "JSON.parse(require('fs').readFileSync(0)); console.log('✓ ideas.json valid')"
        cat sprints.json | node -e "JSON.parse(require('fs').readFileSync(0)); console.log('✓ sprints.json valid')"
        cat projects.json | node -e "JSON.parse(require('fs').readFileSync(0)); console.log('✓ projects.json valid')"
    
    - name: Validate HTML
      run: |
        test -f index.html
        test -f now.html
        test -f projects.html
        test -f dashboard.html
        test -f tools.html
        echo "✓ Core HTML files present"
    
    - name: Check docs are updated
      run: |
        test -f README.md
        test -f API.md
        test -f CHANGELOG.md
        test -f ROADMAP.md
        test -f TROUBLESHOOTING.md
        test -f docs/WORKFLOWS.md
        test -f docs/AI_INTEGRATION.md
        echo "✓ Documentation present"

    - name: Check Makefile targets
      run: |
        make help | grep -q "install" && echo "✓ Makefile has install target"
        make help | grep -q "test" && echo "✓ Makefile has test target"
        make stats

    - name: Verify data directory structure
      run: |
        mkdir -p data
        test -d data || (echo "data/ directory missing" && exit 1)
        echo "✓ Data directory exists"

    - name: Check Python scripts syntax
      run: |
        python3 -m py_compile arbitrage_bot_v2.py 2>/dev/null && echo "✓ arbitrage_bot_v2.py valid" || echo "⚠ Python syntax check skipped"
        python3 -m py_compile polymarket_bot.py 2>/dev/null && echo "✓ polymarket_bot.py valid" || echo "⚠ Python syntax check skipped"
