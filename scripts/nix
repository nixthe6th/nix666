#!/bin/bash
#
# nix - Unified CLI for all Nix tools
# Usage: nix <command> [args]
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

show_help() {
    cat << 'EOF'
âš¡ nix - Unified CLI toolkit

Usage: nix <command> [args]

Commands:
  timer <min> [task]      Focus timer (nixtimer wrapper)
  do <task> [priority]    Add a task (nixdo wrapper)
  note <idea>             Capture an idea (nixnote wrapper)
  dump                    Brain dump mode (nixdump wrapper)
  track <cmd> [args]      Income tracking (nixtrack wrapper)
  init [project]          Scaffold new project (nixinit wrapper)
  log                     Create daily log entry (dailylog.sh)
  status                  System status check
  sprint "msg"            Git commit & push
  count <file> [goal]     Word count (wcc wrapper)
  quote [search|list]     Show random quote or search
  focus [minutes]         Pomodoro timer (default 25m)
  done "what" [durs]      Log sprint completion
  today                   Daily briefing and summary
  streak                  Show git activity streak
  stats [options]         Productivity dashboard (--sprints, --tasks, --json)
  check                   API health check
  week [--commits]        Weekly retrospective
  bm [cmd]                Bookmark manager (list/search/open/add)
  ideas [cmd]             Idea backlog management
  todo [cmd]              Task tracker (add/list/done/priority)
  log [cmd]               Daily logger (add/show/search)
  habits [cmd]            Daily habit tracker (check/list/stats)
  mood [cmd]              Daily mood tracker (log/show/stats)
  session [cmd]           Work session tracker (start/stop/log/stats)
  calc <expr>             Quick calculator (math, time, finance)
  when <expression>       Time calculator (deadlines, countdowns)
  docs [--html]           Regenerate API documentation
  weather [location]      Quick weather check
  pass [options]          Password generator
  server [port]           Quick HTTP server
  find <query>            Search across all data
  tag [cmd]               Universal tag manager (list/search/cloud)
  convert <cmd> [input]   Data converter (b64, url, json, case)
  qr <text|wifi|contact>  Generate QR codes for URLs, WiFi, contacts
  backup [cmd]            Backup/export data (list/export/clean)
  decide [cmd]            Decision log (add/list/review/stats)
  water [cmd]             Hydration tracker (add/status/week/goal)
  expense [cmd]           Expense tracker (add/list/summary/budget)
  commit [msg]            Quick git commit helper (--sprint for rapid mode)
  standup [period]        Daily standup report (today/yesterday/week)
  later [url|cmd]         Read/watch later queue (add/list/done)
  learn [cmd]             Learning tracker with spaced repetition
  flashcard [cmd]         Flashcard system for memorization
  clip [cmd]              Code snippet manager (add/list/search/copy)
  roll [dice|coin|n]      Dice roller (2d6, coin, 100)
  summarize <file>        Summarize text/articles (-n 5 for 5 sentences)
  uuid [options]          Generate UUIDs and random IDs (-s short, -n nano)
  zettel [cmd]            Zettelkasten note system (new/list/search/link)
  connect [cmd]           Discover note connections (related/orphaned/suggest)
  export [format]         Export data (json/csv/markdown)
  
  tools                   List all available tools
  help                    Show this help

Examples:
  nix do "fix login bug" high
  nix note "AI automation idea"
  nix track income 150 "Blog post"
  nix sprint "Add new feature"

EOF
}

list_tools() {
    echo "âš¡ Available nix tools:"
    echo ""
    ls -1 "$SCRIPT_DIR"/nix* 2>/dev/null | while read -r tool; do
        name=$(basename "$tool")
        desc=""
        case "$name" in
            nixdo) desc="Task tracker with priorities" ;;
            nixnote) desc="Structured idea capture" ;;
            nixdump) desc="Raw brain dump mode" ;;
            nixtrack) desc="Income/order tracking" ;;
            nixinit) desc="Project scaffolding" ;;
            nixtimer) desc="Focus timer" ;;
            nixsprint) desc="Sprint management" ;;
            nixrate) desc="Freelance rate calc" ;;
    nixweather) desc="Weather checker" ;;
            nixdecide) desc="Decision log" ;;
            nixwater) desc="Hydration tracker" ;;
            nixcommit) desc="Quick git commit helper" ;;
        esac
        printf "  %-10s %s\n" "$name" "$desc"
    done
    echo ""
    echo "ðŸ“¦ Root-level tools (via 'nix' command):"
    printf "  %-10s %s\n" "quote.js" "Motivation quotes"
    printf "  %-10s %s\n" "focus.js" "Pomodoro timer"
    printf "  %-10s %s\n" "done.js" "Sprint tracker"
    printf "  %-10s %s\n" "streak.js" "Git streak"
    printf "  %-10s %s\n" "projstats.js" "Stats dashboard"
    printf "  %-10s %s\n" "apicheck.js" "API health check"
    printf "  %-10s %s\n" "bm.js" "Bookmark manager"
    printf "  %-10s %s\n" "ideas.js" "Idea backlog"
    printf "  %-10s %s\n" "todo.js" "Task tracker"
    printf "  %-10s %s\n" "log.js" "Daily logger"
    printf "  %-10s %s\n" "habits.js" "Habit tracker"
    printf "  %-10s %s\n" "mood.js" "Mood tracker"
    printf "  %-10s %s\n" "session.js" "Work session tracker"
    printf "  %-10s %s\n" "calc.js" "Quick calculator"
    printf "  %-10s %s\n" "pass.js" "Password generator"
    printf "  %-10s %s\n" "server.js" "Quick HTTP server"
    printf "  %-10s %s\n" "find.js" "Universal search"
    printf "  %-10s %s\n" "convert.js" "Data format converter"
    printf "  %-10s %s\n" "backup.js" "Data backup and export"
    printf "  %-10s %s\n" "water.js" "Hydration tracker"
    printf "  %-10s %s\n" "standup.js" "Daily standup report"
    printf "  %-10s %s\n" "later.js" "Read/watch later queue"
    printf "  %-10s %s\n" "learn.js" "Learning tracker with SRS"
    printf "  %-10s %s\n" "summarize.js" "Text summarizer"
    printf "  %-10s %s\n" "uuid.js" "UUID and random ID generator"
    printf "  %-10s %s\n" "sleep.js" "Sleep quality tracker"
    printf "  %-10s %s\n" "workout.js" "Workout logger"
    printf "  %-10s %s\n" "zettel.js" "Zettelkasten notes"
    printf "  %-10s %s\n" "connect.js" "Discover note connections"
  printf "  %-10s %s\n" "export.js" "Export data in multiple formats"
    echo ""
    echo "Run 'nix help' for usage"
}

main() {
    local cmd="${1:-help}"
    shift || true

    case "$cmd" in
        timer)
            "$SCRIPT_DIR/nixtimer" "$@"
            ;;
        do)
            "$SCRIPT_DIR/nixdo" add "$@"
            ;;
        note)
            if [ $# -eq 0 ]; then
                "$SCRIPT_DIR/nixnote"
            else
                "$SCRIPT_DIR/nixnote" "$@"
            fi
            ;;
        dump)
            "$SCRIPT_DIR/nixdump"
            ;;
        track)
            "$SCRIPT_DIR/nixtrack" "$@"
            ;;
        init)
            "$SCRIPT_DIR/nixinit" "$@"
            ;;
        log)
            "$SCRIPT_DIR/dailylog.sh"
            ;;
        status)
            "$SCRIPT_DIR/status.sh"
            ;;
        sprint)
            if [ $# -eq 0 ]; then
                echo "Usage: nix sprint \"commit message\""
                exit 1
            fi
            "$SCRIPT_DIR/sprint.sh" "$@"
            ;;
        count)
            if [ $# -eq 2 ]; then
                "$SCRIPT_DIR/wcc" "$@"
            else
                "$SCRIPT_DIR/wordcount" "$@"
            fi
            ;;
        quote)
            node "$SCRIPT_DIR/../quote.js" "$@"
            ;;
        focus)
            node "$SCRIPT_DIR/../focus.js" "$@"
            ;;
        done)
            node "$SCRIPT_DIR/../done.js" "$@"
            ;;
        streak)
            node "$SCRIPT_DIR/../streak.js" "$@"
            ;;
        stats)
            node "$SCRIPT_DIR/../stats.js" "$@"
            ;;
        check)
            node "$SCRIPT_DIR/../apicheck.js"
            ;;
        week)
            node "$SCRIPT_DIR/../week.js" "$@"
            ;;
        bm)
            node "$SCRIPT_DIR/../bm.js" "$@"
            ;;
        calc)
            node "$SCRIPT_DIR/../calc.js" "$@"
            ;;
        docs)
            node "$SCRIPT_DIR/../docs.js" "$@"
            echo "âœ“ API.md regenerated"
            ;;
        weather)
            "$SCRIPT_DIR/nixweather" "$@"
            ;;
        ideas)
            node "$SCRIPT_DIR/../ideas.js" "$@"
            ;;
        log)
            node "$SCRIPT_DIR/../log.js" "$@"
            ;;
        todo)
            node "$SCRIPT_DIR/../todo.js" "$@"
            ;;
        habits)
            node "$SCRIPT_DIR/../habits.js" "$@"
            ;;
        mood)
            node "$SCRIPT_DIR/../mood.js" "$@"
            ;;
        session)
            node "$SCRIPT_DIR/../session.js" "$@"
            ;;
        pass)
            node "$SCRIPT_DIR/../pass.js" "$@"
            ;;
        server)
            node "$SCRIPT_DIR/../server.js" "$@"
            ;;
        find)
            node "$SCRIPT_DIR/../find.js" "$@"
            ;;
        tag)
            node "$SCRIPT_DIR/../tag.js" "$@"
            ;;
        convert)
            node "$SCRIPT_DIR/../convert.js" "$@"
            ;;
        qr)
            node "$SCRIPT_DIR/../qr.js" "$@"
            ;;
        standup)
            node "$SCRIPT_DIR/../standup.js" "$@"
            ;;
        later)
            node "$SCRIPT_DIR/../later.js" "$@"
            ;;
        learn)
            node "$SCRIPT_DIR/../learn.js" "$@"
            ;;
        backup)
            node "$SCRIPT_DIR/../backup.js" "$@"
            ;;
        decide)
            "$SCRIPT_DIR/nixdecide" "$@"
            ;;
        water)
            "$SCRIPT_DIR/nixwater" "$@"
            ;;
        when)
            "$SCRIPT_DIR/nixwhen" "$@"
            ;;
        today)
            node "$SCRIPT_DIR/../today.js" "$@"
            ;;
        expense)
            node "$SCRIPT_DIR/../expense.js" "$@"
            ;;
        commit)
            "$SCRIPT_DIR/nixcommit" "$@"
            ;;
        roll)
            node "$SCRIPT_DIR/../roll.js" "$@"
            ;;
        clip)
            node "$SCRIPT_DIR/../clip.js" "$@"
            ;;
        uuid)
            node "$SCRIPT_DIR/../uuid.js" "$@"
            ;;
        flashcard)
            node "$SCRIPT_DIR/../flashcard.js" "$@"
            ;;
        summarize)
            node "$SCRIPT_DIR/../summarize.js" "$@"
            ;;
        sleep)
            node "$SCRIPT_DIR/../sleep.js" "$@"
            ;;
        workout)
            node "$SCRIPT_DIR/../workout.js" "$@"
            ;;
        zettel)
            node "$SCRIPT_DIR/../zettel.js" "$@"
            ;;
        connect)
            node "$SCRIPT_DIR/../connect.js" "$@"
            ;;
        export)
            node "$SCRIPT_DIR/../export.js" "$@"
            ;;
        tools)
            list_tools
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            echo "Unknown command: $cmd"
            echo "Run 'nix help' for usage"
            exit 1
            ;;
    esac
}

main "$@"
